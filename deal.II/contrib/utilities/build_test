#!/usr/bin/make -f

#
# A build_test for deal.II
#
# Usage: Invoke this script either in a source directory or with $SOURCEDIR
#        set
#
# The following environment variables may be set:
#
#   SOURCEDIR    - the source directory to use (if not invoked in a source
#                  directory)
#   CONFIGFILE   - A cmake configuration file for the build test
#   LOGDIR       - directory for the log file
#   LOGFILE      - the logfile to use, default to $LOGDIR/$CONFIGFILE.<epoc>.log
#
#   CMAKE        - the cmake executable to use
#   SVN          - svn info command to use
#   TMPDIR       - defaults to "/tmp"
#   CLEAN_TMPDIR - defaults to "true"
#

#
# Specify default values:
#
SOURCEDIR=$(CURDIR)
LOGDIR=$(PWD)
TMPDIR=/tmp
CMAKE=cmake
SVN=svn info

branch:=$(shell $(SVN) $(SOURCEDIR) | perl -ne 'print "$$1" if m/svn\.dealii\.org\/(.+)\/deal.II/;')
revision:=$(shell $(SVN) $(SOURCEDIR) | perl -ne 'print "$$_" if s/Last Changed Rev: //;')

date:= $(shell date +%s)
random:=$(shell echo "$$RANDOM")
testdir:= "$(TMPDIR)"/deal-build-test.$(date)-$(random)
builddir:= $(testdir)/build
installdir:= $(testdir)/install
LOGFILE=$(LOGDIR)/$(firstword $(branch) unknown_branch).$(firstword $(notdir $(CONFIGFILE)) no_configuration).$(date).log
CLEAN_TMPDIR=true

PIPEnTRAP:= >>$(LOGFILE) 2>&1 || (if ${CLEAN_TMPDIR}; then rm -rf $(testdir); fi; false)

.PHONY: main
main:
	@if test ! -f $(SOURCEDIR)/CMakeLists.txt; then echo "ERROR: $(SOURCEDIR) doesn't seem to be a top-level source directory"; false; fi
	mkdir -p $(LOGDIR)
	mkdir -p $(builddir)
	mkdir -p $(installdir)
	@echo "AUTOMATED DEAL.II BUILD TEST" | tee $(LOGFILE)
	@echo "BEGIN HEADER `date -u '+%Y-%m-%d %T'`" | tee -a $(LOGFILE)
	@echo "dealii-feature: branch=$(branch)" | tee -a $(LOGFILE)
	@echo "dealii-feature: revision=$(revision)" | tee -a $(LOGFILE)
	@echo "dealii-feature: user=$(USER)" | tee -a $(LOGFILE)
	@echo "dealii-feature: host=`hostname`" | tee -a $(LOGFILE)
	@echo "dealii-feature: configuration=`basename \"$(CONFIGFILE)\"`" | tee -a $(LOGFILE)
	@echo END HEADER `date -u '+%Y-%m-%d %T'`\n | tee -a $(LOGFILE)
	@echo "BEGIN CONFIGURE OUTPUT `date -u '+%Y-%m-%d %T'`" | tee -a $(LOGFILE)
	cd $(builddir) && "$(CMAKE)" -C "$(CONFIGFILE)" -DCMAKE_INSTALL_PREFIX=$(installdir) $(SOURCEDIR) $(PIPEnTRAP)
	@echo "END CONFIGURE OUTPUT `date -u '+%Y-%m-%d %T'`" | tee -a $(LOGFILE)
	@echo "BEGIN CMAKE SYSTEM INFORMATION `date -u '+%Y-%m-%d %T'`" | tee -a $(LOGFILE)
	cd $(builddir) && "$(CMAKE)" --system-information $(PIPEnTRAP)
	@echo "END CMAKE SYSTEM INFORMATION `date -u '+%Y-%m-%d %T'`" | tee -a $(LOGFILE)
	@echo "BEGIN REPORT FEATURES `date -u '+%Y-%m-%d %T'`" | tee -a $(LOGFILE)
	cd $(builddir) && make $(MAKEOPTS) run_report_features $(PIPEnTRAP)
	@echo "END REPORT FEATURES `date -u '+%Y-%m-%d %T'`" | tee -a $(LOGFILE)
	@echo "BEGIN BUILD INSTALL OUTPUT `date -u '+%Y-%m-%d %T'`" | tee -a $(LOGFILE)
	cd $(builddir) && make $(MAKEOPTS) install $(PIPEnTRAP)
	@echo "END BUILD INSTALL OUTPUT `date -u '+%Y-%m-%d %T'`" | tee -a $(LOGFILE)
	@echo "BEGIN BUILD EXAMPLES OUTPUT `date -u '+%Y-%m-%d %T'`" | tee -a $(LOGFILE)
	cd $(installdir)/examples && make -f $(SOURCEDIR)/contrib/utilities/build_test DEAL_II_DIR=$(installdir) build_examples $(PIPEnTRAP)
	@echo "END BUILD EXAMPLES OUTPUT `date -u '+%Y-%m-%d %T'`" | tee -a $(LOGFILE)
	#@echo "BEGIN RUN EXAMPLES OUTPUT `date -u '+%Y-%m-%d %T'`" | tee -a $(LOGFILE)
	#cd $(installdir)/examples && make -f $(SOURCEDIR)/contrib/utilities/build_test run_examples $(PIPEnTRAP)
	#@echo "END RUN EXAMPLES OUTPUT `date -u '+%Y-%m-%d %T'`" | tee -a $(LOGFILE)
	@echo "BUILD TEST SUCCESSFUL `date -u '+%Y-%m-%d %T'`" | tee -a $(LOGFILE)
	if ${CLEAN_TMPDIR}; then rm -rf $(testdir); fi


#
# Recipes used for testing the example steps
#

steps:= $(wildcard step-*)

%/%:
	-cd $(@D) && cmake . >/dev/null 2>&1
	cd $(@D) && if [ -f Makefile ]; then make; fi

%/OK: %/%
	cd $(@D) && if [ -f Makefile ]; then make run; fi && touch OK

.PHONY: build_examples
build_examples: $(steps:%=%/%)

.PHONY: run_examples
run_examples: $(steps:%=%/OK)

