#!/usr/bin/gmake -f

#
# A build_test for deal.II
#
# Usage: Invoke this script in a source directory
#
# The following environment variables may be set:
#
#   SOURCEDIR  - the source directory to use (if not invoked in a source
#                directory)
#   LOGDIR     - directory for the log file
#   CONFIGFILE - A cmake configuration file for the build test
#
#   CMAKE      - the cmake executable to use
#   SVN        - svn info command to use
#   TMPDIR     - defaults to "/tmp"
#   CLEANUP    - defaults to "true"
#

SOURCEDIR=$(CURDIR)
TMPDIR=/tmp
CMAKE=cmake
SVN=svn info .
date:= $(shell date +%s)
random:=$(shell echo "$$RANDOM")
testdir:= "$(TMPDIR)"/deal-build-test.$(date)-$(random)
builddir:= $(testdir)/build
installdir:= $(testdir)/install
LOGDIR=$(PWD)
logfile:=$(LOGDIR)/$(date).$(firstword $(notdir $(CONFIGFILE)) automatic).log
CLEANUP=true

TEEnTRAP:= | tee -a $(logfile) || (if ${CLEANUP}; then rm -rf $(testdir); fi; false)
PIPEnTRAP:= >>$(logfile) 2>&1 || (if ${CLEANUP}; then rm -rf $(testdir); fi; false)

.PHONY: main
main:
	mkdir -p $(LOGDIR)
	mkdir -p $(builddir)
	mkdir -p $(installdir)
	@echo "AUTOMATED DEAL.II BUILD TEST" | tee $(logfile)
	@echo "BEGIN HEADER `date -u '+%Y-%m-%d %T'`" | tee -a $(logfile)
	@$(SVN) | perl -ne 'print "dealii-feature: revision=$$_" if s/Last Changed Rev: //; print "dealii-feature: branch=$$1\n" if m/svn\.dealii\.org\/(.+)\/deal.II/;' $(TEEnTRAP)
	@echo "dealii-feature: user=$(USER)" | tee -a $(logfile)
	@echo "dealii-feature: host=`hostname`" | tee -a $(logfile)
	@echo "dealii-feature: configuration=`basename \"$(CONFIGFILE)\"`" | tee -a $(logfile)
	@echo END HEADER `date -u '+%Y-%m-%d %T'`\n | tee -a $(logfile)
	@echo "BEGIN CONFIGURE OUTPUT `date -u '+%Y-%m-%d %T'`" | tee -a $(logfile)
	cd $(builddir) && "$(CMAKE)" -C "$(CONFIGFILE)" -DCMAKE_INSTALL_PREFIX=$(installdir) $(PWD) $(PIPEnTRAP)
	@echo "END CONFIGURE OUTPUT `date -u '+%Y-%m-%d %T'`" | tee -a $(logfile)
	@echo "BEGIN CMAKE SYSTEM INFORMATION `date -u '+%Y-%m-%d %T'`" | tee -a $(logfile)
	cd $(builddir) && "$(CMAKE)" --system-information $(PIPEnTRAP)
	@echo "END CMAKE SYSTEM INFORMATION `date -u '+%Y-%m-%d %T'`" | tee -a $(logfile)
	@echo "BEGIN REPORT FEATURES `date -u '+%Y-%m-%d %T'`" | tee -a $(logfile)
	cd $(builddir) && make $(MAKEOPTS) run_report_features $(PIPEnTRAP)
	@echo "END REPORT FEATURES `date -u '+%Y-%m-%d %T'`" | tee -a $(logfile)
	@echo "BEGIN BUILD INSTALL OUTPUT `date -u '+%Y-%m-%d %T'`" | tee -a $(logfile)
	cd $(builddir) && make $(MAKEOPTS) install $(PIPEnTRAP)
	@echo "END BUILD INSTALL OUTPUT `date -u '+%Y-%m-%d %T'`" | tee -a $(logfile)
	@echo "BEGIN BUILD EXAMPLES OUTPUT `date -u '+%Y-%m-%d %T'`" | tee -a $(logfile)
	cd $(installdir)/examples && make -f $(SOURCEDIR)/contrib/utilities/build_test $(MAKEOPTS) build_examples $(PIPEnTRAP)
	@echo "END BUILD EXAMPLES OUTPUT `date -u '+%Y-%m-%d %T'`" | tee -a $(logfile)
	@echo "BEGIN RUN EXAMPLES OUTPUT `date -u '+%Y-%m-%d %T'`" | tee -a $(logfile)
	cd $(installdir)/examples && make -f $(SOURCEDIR)/contrib/utilities/build_test run_examples $(PIPEnTRAP)
	@echo "END RUN EXAMPLES OUTPUT `date -u '+%Y-%m-%d %T'`" | tee -a $(logfile)
	rm -rf $(testdir)


#
# Recipes used for testing the example steps
#

steps:= $(wildcard step-*)

%/Makefile:
	-cd $(@D) && cmake . > configure.log 2>&1

.PHONY: configure_examples
configure_examples: $(steps:%=%/Makefile)

%/%: %/Makefile
	cd $(@D) && if [ -f Makefile ]; then (make > build.log 2>&1); fi

.PHONY: build_examples
build_examples: $(steps:%=%/%)

%/OK: %/%
	cd $(@D) && if [ -f Makefile ]; then (make run > run.log 2>&1); fi && touch OK

.PHONY: run_examples
run_examples: $(steps:%=%/OK)

