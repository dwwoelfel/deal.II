<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
	  "http://www.w3.org/TR/html4/loose.dtd">
<html>
  <head>
    <title>The deal.II Readme on interfacing to PETSc</title>
    <link href="../screen.css" rel="StyleSheet">
    <meta name="author" content="the deal.II authors <authors @ dealii.org>">
    <meta name="copyright" content="Copyright (C) 2008, 2009, 2010, 2011, 2012 by the deal.II authors">
    <meta name="date" content="$Date$">
    <meta name="svn_id" content="$Id$">
    <meta name="keywords" content="deal.II">
  </head>

  <body>

    <h1>Interfacing <acronym>deal.II</acronym> to PETSc</h1>

    <p>
      <a href="http://www.mcs.anl.gov/petsc/"
      target="_top">PETSc</a> is a
      software package that provides lots of functionality for linear
      algebra, among other things. For example, it includes implementations of a variety of
      linear solvers, as well as various different sparse and dense matrix and
      vector formats. Of particular interest to deal.II is their ability to
      provide this functionality both on sequential and parallel (using MPI)
      computers.
    </p>

    <p>
      <acronym>deal.II</acronym> has wrapper classes to the linear algebra
      parts of PETSc that provide almost the
      same interfaces as the built-in <acronym>deal.II</acronym> linear
      algebra classes. We use these interfaces for parallel computations based
      on MPI since the native deal.II linear algebra classes lack this
      ability. They are used, among other programs, in step-17, step-18 and
      step-40.
    </p>

    <h4>Installing <acronym>deal.II</acronym> with PETSc</h4>

    <p>
      For a general overview of building <acronym>deal.II</acronym> with
      PETSc, first see the <a href="../readme.html">ReadMe file</a>.
    </p>

    <p>
      PETSc usually requires you to set the
      environment variables <code>PETSC_DIR</code> and <code>PETSC_ARCH</code>
      to a path to PETSc and denoting the architecture for which PETSc is
      compiled. If these environment variables are set, then
      <acronym>deal.II</acronym> will pick them up during
      configuration, and store them. It will then also recognize that
      PETSc shall be used, and enable the wrapper classes.
    </p>

    <p>
      Alternatively, the <code>-DPETSC_DIR=DIR</code> and
      <code>-DPETSC_ARCH=ARCH</code> options for <code>cmake</code>
      can be used to override the values of <code>PETSC_DIR</code>
      and <code>PETSC_ARCH</code> or if these environment
      variables are not set at all. If you do have a PETSc
      installation and have set the <code>PETSC_DIR</code> and
      <code>PETSC_ARCH</code> environment variables but do not wish
      <acronym>deal.II</acronym> to be configured for PETSc use, you
      should specify <code>-DDEAL_II_WITH_PETSC=OFF</code> as a flag
      during configuration.
    </p>

    <p>
      <b>Note:</b> PETSc appears not to co-operate
      well when using threads and some programs crash when deal.II is
      compiled in its usual mode supporting multithreading. If you see
      this sort of behavior, disable
      multithreading upon configuration of <acronym>deal.II</acronym>
      using the <code>-DDEAL_II_WITH_THREADS=OFF</code> switch for
      <code>cmake</code>.
    </p>

    <p><b>Note:</b> <acronym>deal.II</acronym> can be installed with both
      PETSc and Trilinos and they do not usually get in their
      respective ways. There are, however, occasions where this is not true
      and this fundamentally comes from the fact that both of these packages
      are built from subpackages that are developed by independent
      groups. Unfortunately, some of these sub-packages can be configured to
      be part of both PETSc and Trilinos, and if you try to
      use <acronym>deal.II</acronym> with versions of PETSc and Trilinos
      that <i>both</i> contain a particular sub-package, little good will come
      of it in general. In particular, we have experienced this with the ML
      package that can serve as an algebraic multigrid method to both PETSc
      and Trilinos. If both of these packages are configured to use ML, then
      difficult to understand error messages at compile or link time are
      almost inevitable, and there is little the <acronym>deal.II</acronym>
      build system can do to prevent this. Thus, <i>don't try to do that!</i>
    </p>


    <h4>Installing PETSc</h4>


    <p>
      Installing PETSc correctly can be a bit of a
      challenge. To start, take a look at
      the <a href="http://www.mcs.anl.gov/petsc/documentation/installation.html"
      target="_top">PETSc installation instructions</a>. We have found that
      the following steps generally appear to work where we simply unpack and
      build PETSc in its final location (i.e., we do not first build and then
      install it into a separate directory):
      <pre>

	tar xvzf petsc-x-y-z.tar.gz
        cd petsc-x-y-z
	export PETSC_DIR=`pwd`
	export PETSC_ARCH=x86_64       # or any other identifying text for your machine
	export LD_LIBRARY_PATH=$PETSC_DIR/$PETSC_ARCH/lib:$LD_LIBRARY_PATH
	./config/configure.py --with-shared=1 --with-x=0 --with-mpi=1 --download-hypre=1
	make
      </pre>
    </p>

    <p>
      This automatically builds PETSc with both MPI and the algebraic
      multigrid preconditioner package Hypre (which we use in step-40). You
      may wish to put the <code>export</code> commands into
      your <code>~/.bashrc</code> or <code>~/.cshrc</code> files, with the
      first one replaced by something of the kind
      <pre>

	export PETSC_DIR=/path/to/petsc-x-y-z
      </pre>
    </p>

    <hr>

    <address>
      <a href="../mail.html" target="body">The deal.II Group</a>
      $Date$
    </address>
  </body>
</html>
