# Makefile,v 1.8 1999/04/15 17:36:14 wolf Exp


# Let ./configure insert whether MG shall be documented
multigrid = @enablemultigrid@


# specify which are the include files that a specific documentation libary
# depends upon
kdoc.base     = $(shell echo ../../base/include/base/*.h)
kdoc.lac      = $(shell echo ../../lac/include/lac/*.h)
kdoc.grid     = $(shell echo ../../deal.II/include/grid/*.h)
kdoc.dof      = $(shell echo ../../deal.II/include/dofs/*.h) \
                $(shell echo ../../deal.II/include/fe/*.h)
kdoc.numerics = $(shell echo ../../deal.II/include/numerics/*.h)

ifeq ($(multigrid),yes)
kdoc.multigrid= $(shell echo ../../deal.II/include/multigrid/*.h)
endif

# for latex-output, we join the different libraries of the
# deal.II library into just one file
kdoc.dealII = $(kdoc.grid) $(kdoc.dof) $(kdoc.numerics)

# include global paths and variables
include ../../common/Make.global_options

ifeq ($(shell uname),SunOS)
DOCPP = /home/people/wolf/Config/doc++/bin/doc++
#DOCPP = /home/people/kanschat/bin/doc++
else
DOCPP = doc++
endif


# by default: make library doc and generate an index of all names
default: kdoc kdoc/names.html

# alternatively: do the above and also generate a backlog of CVS
# changes in the last 100 days
all: default cvslog


#################################################################################
##  targets for cvslog generated HTML output    
#################################################################################

cvslog:
	cd ../.. ; $(PERL) doc/auto/scripts/cvs2html -o doc/auto/cvs-backlog/newdeal -a -k -D 100



#################################################################################
##  targets for kdoc generated HTML output    
#################################################################################

# Make in kdoc subdirectory

kdoc:
	@cd kdoc ; $(MAKE)

# Will not work for kdoc2

kdoc/names.html: $(kdoc.libray-files)
	@cd kdoc ; $(PERL) ../scripts/index.pl *.kdoc > names.html




#################################################################################
##  targets for DOC++ generated latex output    
#################################################################################

# generate the input file for doc++
%.doc++: Makefile
	@echo $(kdoc.$(subst .doc++,,$(subst latex/,,$@)))  | \
	 $(PERL) -pi -e 's# #\n#g;  s#\.\./\.\./#//\@Include: ../../../#g;' > \
	 $@


# generate one of the latex-output files; this needs the respective
# include file for DOC++
#
# delete the .doc++ files immediately again, since they are no more 
# used and since this forces make to re-make the .tex-file each time
# we ask for it; the right way to do so would be to use dependencies,
# but it is hard to compute them from the '%'-sign used in the rule
%.tex: %.doc++
	$(DOCPP) -p -t -u -o $@ -ep a4wide $<
	rm $^


# generate temporary files from the doc++-latex-output which have
# headers and footers stripped and label names replaced by something
# file dependent
%.tex1: %.tex
	cat $<                           | \
	 $(PERL) scripts/process-tex        | \
	 $(PERL) -pi -e 's/cxx\./$(basename $(notdir $@)).cxx./g;' > $@

latex/deal_II_technical_reference.tex: latex/base.tex1 latex/lac.tex1 latex/dealII.tex1
	@cat latex/header.tex                              > $@
	@echo "\\\\chapter{Base library}"                 >> $@
	@echo "\\\\def\\\\presentlib{base}"               >> $@
	@cat latex/base.tex1                              >> $@
	@echo "\\\\chapter{Linear algebra library}"       >> $@
	@echo "\\\\def\\\\presentlib{lac}"                >> $@
	@cat latex/lac.tex1                               >> $@
	@echo "\\\\chapter{deal.II library}"              >> $@
	@echo "\\\\def\\\\presentlib{dealII}"             >> $@
	@cat latex/dealII.tex1                            >> $@
	@cat latex/footer.tex                             >> $@
	rm $^



# generate the latex-processed files from these
%.dvi: %.tex
	cd latex ; latex $(notdir $<)
	cd latex ; latex $(notdir $<)
	-rm $(subst .tex,.log,$<)
	-rm $(subst .tex,.aux,$<)
	-rm $(subst .tex,.toc,$<)


# generate postscript files from a latex output file
%.ps: %.dvi
	cd latex ; dvips $(notdir $<) -o $(notdir $@)




#################################################################################
##  administrativa
#################################################################################
clean:
	-rm -f kdoc/names.html kdoc/*.kdoc kdoc/*/*.html cvs-backlog/*.html \
		latex/base.* latex/lac.* latex/dealII.* \
                latex/deal_II_technical_reference.* \
		*.doc++


.PHONY: default all kdoc $(kdoc.library-files) $(kdoc.library-files.rerun) doc++ clean
