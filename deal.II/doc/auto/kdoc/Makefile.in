############################################################
# $Id$
############################################################

D           = @DEAL2_DIR@
multigrid   = @enablemultigrid@
kdocdir     = @kdocdir@
kdocversion = @kdocversion@


include $D/common/Make.global_options

ifeq ($(kdocversion),1)
KDOCFLAGS=-I$(kdocdir) $(kdocdir)/kdoc -a -p -L $D/doc/auto/kdoc
else
KDOCFLAGS=-I$(kdocdir) $(kdocdir)/kdoc -a -p \
          --html-logo ../../../pictures/deal.II_3.0_1.150.jpg \
          -L $D/doc/auto/kdoc -n
endif

kdoc.base     = $(shell echo $D/base/include/base/*.h)
kdoc.lac      = $(shell echo $D/lac/include/lac/*.h)
kdoc.grid     = $(shell echo $D/deal.II/include/grid/*.h)
kdoc.dof      = $(shell echo $D/deal.II/include/dofs/*.h) \
                $(shell echo $D/deal.II/include/fe/*.h)
kdoc.numerics = $(shell echo $D/deal.II/include/numerics/*.h)
kdoc.multigrid= $(shell echo $D/deal.II/include/multigrid/*.h)


# specify the names of the resulting doc libraries
ifeq ($(multigrid),yes)
kdoc.library-files = base.kdoc         \
                     lac.kdoc          \
                     grid.kdoc         \
                     dof.kdoc          \
                     numerics.kdoc     \
                     multigrid.kdoc
else
kdoc.library-files = base.kdoc         \
                     lac.kdoc          \
                     grid.kdoc         \
                     dof.kdoc          \
                     numerics.kdoc
endif

kdoc: kdoc-installed $(kdoc.library-files)


# check whether kdoc is already installed. if not, then try to do so
kdoc-installed:
	@if test ! -d $(kdocdir) ; then  \
	    echo "========================================" ; \
	    echo "Trying to install kdoc first" ;  \
	    echo "========================================" ; \
	    cd $(kdocdir:kdoc/bin=kdoc) ;    \
	    $(MAKE) install ;  \
	    echo "========================================" ; \
	    echo "Done" ;  \
	    echo "========================================" ; \
        fi


# now for the generation of the documentation of the sublibraries.
# first let kdoc generate the whole thing, then loop over all output
# files and fix the #include<...> directives to only contain the 
# paths that are needed inside the programs instead of the global
# paths

base.kdoc: kdoc-installed $(kdoc.base)
	@$(PERL) $(KDOCFLAGS) $(subst .kdoc,,$@) -d $(subst .kdoc,,$@) \
	$(^:kdoc-installed=)
	for htmlfile in $(subst .kdoc,,$@)/*html ; do \
	    echo "Fixing include paths in $$htmlfile..." ; \
	    perl -pi -e 's,(#include &lt;<A HREF=\"[^\"]+\">)$D/?[^/]+/include/,$$1,g;' "$$htmlfile" ;\
	done
	  	

lac.kdoc: kdoc-installed $(kdoc.lac)
	@$(PERL) $(KDOCFLAGS) $(subst .kdoc,,$@) -d $(subst .kdoc,,$@) \
	-l base $(^:kdoc-installed=)
	for htmlfile in $(subst .kdoc,,$@)/*html ; do \
	    echo "Fixing include paths in $$htmlfile..." ; \
	    perl -pi -e 's,(#include &lt;<A HREF=\"[^\"]+\">)$D/?[^/]+/include/,$$1,g;' "$$htmlfile" ;\
	done

grid.kdoc: kdoc-installed $(kdoc.grid)
	@$(PERL) $(KDOCFLAGS) $(subst .kdoc,,$@) -d $(subst .kdoc,,$@) \
	-l base -llac $(^:kdoc-installed=)
	for htmlfile in $(subst .kdoc,,$@)/*html ; do \
	    echo "Fixing include paths in $$htmlfile..." ; \
	    perl -pi -e 's,(#include &lt;<A HREF=\"[^\"]+\">)$D/?[^/]+/include/,$$1,g;' "$$htmlfile" ;\
	done

dof.kdoc: kdoc-installed $(kdoc.dof)
	@$(PERL) $(KDOCFLAGS) $(subst .kdoc,,$@) -d $(subst .kdoc,,$@) \
	-l base -llac -lgrid $(^:kdoc-installed=)
	for htmlfile in $(subst .kdoc,,$@)/*html ; do \
	    echo "Fixing include paths in $$htmlfile..." ; \
	    perl -pi -e 's,(#include &lt;<A HREF=\"[^\"]+\">)$D/?[^/]+/include/,$$1,g;' "$$htmlfile" ;\
	done

numerics.kdoc: kdoc-installed $(kdoc.numerics)
	@$(PERL) $(KDOCFLAGS) $(subst .kdoc,,$@) -d $(subst .kdoc,,$@) \
	-l base -llac -lgrid -ldof $(^:kdoc-installed=)
	for htmlfile in $(subst .kdoc,,$@)/*html ; do \
	    echo "Fixing include paths in $$htmlfile..." ; \
	    perl -pi -e 's,(#include &lt;<A HREF=\"[^\"]+\">)$D/?[^/]+/include/,$$1,g;' "$$htmlfile" ;\
	done

multigrid.kdoc: kdoc-installed $(kdoc.multigrid)
	@$(PERL) $(KDOCFLAGS) $(subst .kdoc,,$@) -d $(subst .kdoc,,$@) \
	-l base -llac -lgrid -ldof -lnumerics $(^:kdoc-installed=)
	for htmlfile in $(subst .kdoc,,$@)/*html ; do \
	    echo "Fixing include paths in $$htmlfile..." ; \
	    perl -pi -e 's,(#include &lt;<A HREF=\"[^\"]+\">)$D/?[^/]+/include/,$$1,g;' "$$htmlfile" ;\
	done

